#
# Copyright 2017 Atypon Systems, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

publisher-session.dao.neo4j.create = \
    OPTIONAL MATCH (d:Device {id: {`device.id`}}) \
    OPTIONAL MATCH (p:Publisher {id: {`publisher.id`}}) \
    CREATE (ps:PublisherSession {\
        id: {id}, \
        localId: {localId}, \
        status: {status}, \
        lastActiveDate: {lastActiveDate}, \
        createdDate: {createdDate}, \
        modifiedDate: {modifiedDate} \
    }) \
    FOREACH (d IN CASE WHEN d IS NOT NULL THEN [d] ELSE [] END | \
        CREATE (d)-[:HAS_SESSION]->(ps) \
    ) \
    FOREACH (p IN CASE WHEN p IS NOT NULL THEN [p] ELSE [] END | \
        CREATE (ps)-[:VALID_FOR]->(p) \
    ) \
    RETURN ps.id AS id, \
        ps.localId AS localId, \
        ps.status AS status, \
        d.id AS `device.id`, \
        ps.lastActiveDate AS lastActiveDate, \
        ps.createdDate AS createdDate, \
        ps.modifiedDate AS modifiedDate;

publisher-session.dao.neo4j.read = \
    MATCH (ps:PublisherSession) \
        WHERE ({matchOnId} AND ps.id = {id}) OR ({matchOnLocalId} AND ps.localId = {localId}) \
    WITH ps, \
        CASE \
            WHEN {inflatePublisher} THEN ps \
            ELSE null \
        END AS ps_p, \
        CASE \
            WHEN {inflateIdentityProvider} THEN ps \
            ELSE null \
        END AS ps_idp \
    OPTIONAL MATCH (ps_p)-[:VALID_FOR]->(p) \
    OPTIONAL MATCH (ps_idp)<-[:AUTHENTICATED]-(idp) \
    RETURN ps.id AS id, \
        ps.localId AS localId, \
        ps.status AS status, \
        ps.lastActiveDate AS lastActiveDate, \
        ps.createdDate AS createdDate, \
        ps.modifiedDate AS modifiedDate, \
        idp.id AS `identityProvider.id`, \
        idp.name AS `identityProvider.name`, \
        idp.entityId AS `identityProvider.entityId`, \
        idp.federationId AS `identityProvider.federationId`, \
        idp.createdDate AS `identityProvider.createdDate`, \
        idp.modifiedDate AS `identityProvider.modifiedDate`, \
        p.id AS `publisher.id`, \
        p.status AS `publisher.status`, \
        p.name AS `publisher.name`, \
        p.createdDate AS `publisher.createdDate`, \
        p.modifiedDate AS `publisher.modifiedDate`;

publisher-session.dao.neo4j.update =

publisher-session.dao.neo4j.delete =

publisher-session.dao.neo4j.add-idp-relationship = \
    MATCH (ps:PublisherSession {id: {id}}) \
    MATCH (idp:IdentityProvider {id: {`identityProvider.id`}}) \
    CREATE (idp)-[:AUTHENTICATED]->(ps)

publisher-session.dao.neo4j.filter = \
    MATCH (d:Device {id: {deviceId}}) \
    OPTIONAL MATCH (ps)-[:VALID_FOR]->(p) \
    OPTIONAL MATCH (idp)-[:AUTHENTICATED]->(ps) \
    OPTIONAL MATCH (d)-[:HAS_SESSION]->(ps) \
    RETURN ps.id AS id, \
        ps.localId AS localId, \
        ps.status AS status, \
        d.id AS `device.id`, \
        idp.id AS `identityProvider.id`, \
        p.id AS `publisher.id`, \
        ps.lastActiveDate AS lastActiveDate, \
        ps.createdDate AS createdDate, \
        ps.modifiedDate AS modifiedDate;

publisher-session.dao.neo4j.filter-by-device = \
    MATCH (d:Device {id: {deviceId}}) \
    WITH d \
        MATCH (d)-[:HAS_SESSION]->(ps) \
    WITH ps \
        SKIP {offset} LIMIT {limit} \
    WITH ps, \
        CASE \
            WHEN {inflatePublisher} THEN ps \
            ELSE null \
        END AS ps_p, \
        CASE \
            WHEN {inflateIdentityProvider} THEN ps \
            ELSE null \
        END AS ps_idp \
    OPTIONAL MATCH (ps_p)-[:VALID_FOR]->(p) \
    OPTIONAL MATCH (ps_idp)<-[:AUTHENTICATED]-(idp) \
    RETURN ps.id AS id, \
        ps.localId AS localId, \
        ps.status AS status, \
        ps.lastActiveDate AS lastActiveDate, \
        ps.createdDate AS createdDate, \
        ps.modifiedDate AS modifiedDate, \
        idp.id AS `identityProvider.id`, \
        idp.name AS `identityProvider.name`, \
        idp.entityId AS `identityProvider.entityId`, \
        idp.federationId AS `identityProvider.federationId`, \
        idp.createdDate AS `identityProvider.createdDate`, \
        idp.modifiedDate AS `identityProvider.modifiedDate`, \
        p.id AS `publisher.id`, \
        p.status AS `publisher.status`, \
        p.name AS `publisher.name`, \
        p.createdDate AS `publisher.createdDate`, \
        p.modifiedDate AS `publisher.modifiedDate`;

